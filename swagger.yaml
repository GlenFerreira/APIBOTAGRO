openapi: 3.0.0
info:
  title: API - M√≥dulos Independentes
  version: 1.0.0
  description: |
    Documenta√ß√£o completa das APIs independentes dos m√≥dulos.
    
    Todas as APIs abaixo s√£o **totalmente independentes** do bot WhatsApp e podem ser usadas por qualquer cliente HTTP.
    
    **Servidor em Produ√ß√£o:** https://apibotagro.onrender.com
    **Servidor Local:** http://localhost:3000
  contact:
    name: AgroBOT
    url: https://github.com/GlenFerreira/BOTAgro
  license:
    name: MIT

servers:
  - url: https://apibotagro.onrender.com
    description: Servidor de Produ√ß√£o (Render)
  - url: http://localhost:3000
    description: Servidor Local

tags:
  - name: USDA
    description: APIs para dados de commodities agr√≠colas
  - name: OpenWeather
    description: APIs para previs√£o do tempo
  - name: Clima
    description: APIs para gera√ß√£o de imagens de previs√£o
  - name: Geolocaliza√ß√£o
    description: APIs para processamento de arquivos geogr√°ficos
  - name: Health
    description: Endpoints de sa√∫de do sistema

paths:
  /api/v1/usda/commodity:
    get:
      summary: Busca dados de commodity por nome
      description: |
        Busca dados de uma commodity agr√≠cola por nome, com normaliza√ß√£o autom√°tica usando IA.
        Suporta commodities como milho, soja, trigo, caf√©, algod√£o, a√ß√∫car e arroz.
      tags:
        - USDA
      parameters:
        - name: name
          in: query
          required: true
          description: Nome da commodity (ex: milho, soja, trigo, caf√©, algod√£o, a√ß√∫car, arroz)
          schema:
            type: string
            example: milho
        - name: year
          in: query
          required: false
          description: Ano dos dados (padr√£o: ano atual)
          schema:
            type: integer
            example: 2024
        - name: country
          in: query
          required: false
          description: C√≥digo do pa√≠s (padr√£o: BR)
          schema:
            type: string
            default: BR
            example: BR
      responses:
        '200':
          description: Dados da commodity retornados com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommodityResponse'
              example:
                success: true
                commodity:
                  name: milho
                  code: "0440000"
                  country: BR
                  year: 2024
                data:
                  production:
                    value: 125000
                    formatted: "125.000 mil toneladas"
                  exports:
                    value: 45000
                    formatted: "45.000 mil toneladas"
                  endingStocks:
                    value: 12000
                    formatted: "12.000 mil toneladas"
                timestamp: "2024-11-19T10:00:00.000Z"
        '400':
          description: Par√¢metro obrigat√≥rio ausente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Commodity n√£o encontrada ou dados indispon√≠veis
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/weather/forecast:
    get:
      summary: Busca previs√£o do tempo para 5 dias
      description: |
        Retorna previs√£o do tempo detalhada para os pr√≥ximos 5 dias de uma cidade.
        Inclui temperatura, umidade, vento, chuva e condi√ß√µes clim√°ticas.
        Se houver imagem dispon√≠vel para a cidade, retorna o caminho da imagem.
      tags:
        - OpenWeather
      parameters:
        - name: city
          in: query
          required: true
          description: Nome da cidade
          schema:
            type: string
            example: S√£o Paulo
      responses:
        '200':
          description: Previs√£o do tempo retornada com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WeatherForecastResponse'
              example:
                success: true
                city:
                  name: S√£o Paulo
                  country: BR
                  state: S√£o Paulo
                  coordinates:
                    lat: -23.5505
                    lon: -46.6333
                forecasts:
                  - date: "2024-11-19T12:00:00.000Z"
                    dateFormatted: "Ter√ßa-feira, 19 de novembro"
                    icon: "‚òÅÔ∏è"
                    description: "nuvens dispersas"
                    temperature:
                      current: 23
                      min: 23
                      max: 24
                    humidity: 62
                    windSpeed: 24
                    rain: 0
                hasImage: true
                imagePath: "/path/to/image.png"
                timestamp: "2024-11-19T10:00:00.000Z"
        '400':
          description: Par√¢metro obrigat√≥rio ausente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Cidade n√£o encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/weather/current:
    get:
      summary: Busca clima atual de uma cidade
      description: |
        Retorna dados do clima atual de uma cidade, incluindo temperatura,
        umidade, press√£o, vento, visibilidade e condi√ß√µes clim√°ticas.
      tags:
        - OpenWeather
      parameters:
        - name: city
          in: query
          required: true
          description: Nome da cidade
          schema:
            type: string
            example: S√£o Paulo
      responses:
        '200':
          description: Clima atual retornado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CurrentWeatherResponse'
              example:
                success: true
                city:
                  name: S√£o Paulo
                  country: BR
                  state: S√£o Paulo
                  coordinates:
                    lat: -23.5505
                    lon: -46.6333
                weather:
                  icon: "‚òÅÔ∏è"
                  description: "nuvens dispersas"
                  temperature:
                    current: 23
                    feelsLike: 24
                    min: 20
                    max: 25
                  humidity: 62
                  pressure: 1013
                  windSpeed: 15
                  windDirection: 180
                  visibility: 10
                  clouds: 75
                timestamp: "2024-11-19T10:00:00.000Z"
        '400':
          description: Par√¢metro obrigat√≥rio ausente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Cidade n√£o encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/clima/generate:
    get:
      summary: Gera imagem de previs√£o do tempo
      description: |
        Gera uma imagem de previs√£o do tempo usando a API Windy.
        A imagem √© salva em uma pasta espec√≠fica baseada na camada escolhida.
      tags:
        - Clima
      parameters:
        - name: city
          in: query
          required: true
          description: Nome da cidade
          schema:
            type: string
            example: S√£o Paulo
        - name: layer
          in: query
          required: false
          description: |
            Camada da imagem. Op√ß√µes: satellite, clouds, radar, temp, wind, rain, thunder, rainthunder
            Padr√£o: temp
          schema:
            type: string
            enum: [satellite, clouds, radar, temp, wind, rain, thunder, rainthunder]
            default: temp
            example: temp
        - name: hours
          in: query
          required: false
          description: Horas √† frente (1-168, padr√£o: 24)
          schema:
            type: integer
            minimum: 1
            maximum: 168
            default: 24
            example: 24
      responses:
        '200':
          description: Imagem gerada com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClimaGenerateResponse'
              example:
                success: true
                city: S√£o Paulo
                layer: temp
                hours: 24
                imagePath: "/path/to/saopaulo_windy_temp_24h.png"
                imageUrl: "/api/clima/image/temp/saopaulo_windy_temp_24h.png"
                timestamp: "2024-11-19T10:00:00.000Z"
        '400':
          description: Erro ao gerar imagem (par√¢metros inv√°lidos ou erro no processo)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/clima/images:
    get:
      summary: Lista imagens dispon√≠veis para uma cidade
      description: |
        Retorna lista de todas as imagens de previs√£o dispon√≠veis para uma cidade,
        organizadas por camada.
      tags:
        - Clima
      parameters:
        - name: city
          in: query
          required: true
          description: Nome da cidade
          schema:
            type: string
            example: S√£o Paulo
      responses:
        '200':
          description: Lista de imagens retornada com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClimaImagesResponse'
              example:
                success: true
                city: S√£o Paulo
                images:
                  - layer: temp
                    fileName: saopaulo_windy_temp_24h.png
                    path: "/path/to/image.png"
                    url: "/api/clima/image/temp/saopaulo_windy_temp_24h.png"
                count: 1
                timestamp: "2024-11-19T10:00:00.000Z"
        '400':
          description: Par√¢metro obrigat√≥rio ausente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/geolocalizacao/upload:
    post:
      summary: Faz upload e processa arquivo geogr√°fico
      description: |
        Recebe um arquivo .shp ou .kml e processa para extrair informa√ß√µes sobre propriedades rurais.
        Retorna √°rea total, coordenadas, centroide e bounding box.
      tags:
        - Geolocaliza√ß√£o
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: Arquivo .shp ou .kml
      responses:
        '200':
          description: Arquivo processado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GeolocalizacaoResponse'
        '400':
          description: Erro no processamento do arquivo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/geolocalizacao/info:
    get:
      summary: Informa√ß√µes sobre o m√≥dulo de geolocaliza√ß√£o
      description: Retorna informa√ß√µes sobre formatos suportados e limites do m√≥dulo.
      tags:
        - Geolocaliza√ß√£o
      responses:
        '200':
          description: Informa√ß√µes retornadas com sucesso
          content:
            application/json:
              schema:
                type: object
                properties:
                  module: 
                    type: string
                    example: geolocalizacao
                  supportedFormats:
                    type: array
                    items:
                      type: string
                    example: [".shp", ".kml", ".kmz"]
                  maxFileSize:
                    type: string
                    example: "50MB"

  /health:
    get:
      summary: Verifica o status do servidor
      description: Endpoint de health check para verificar se o servidor est√° funcionando.
      tags:
        - Health
      responses:
        '200':
          description: Servidor est√° funcionando
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time
                  botName:
                    type: string
                    example: Assistente

components:
  schemas:
    CommodityResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        commodity:
          type: object
          properties:
            name:
              type: string
              example: milho
            code:
              type: string
              example: "0440000"
            country:
              type: string
              example: BR
            year:
              type: integer
              example: 2024
        data:
          type: object
          properties:
            production:
              $ref: '#/components/schemas/FormattedValue'
            exports:
              $ref: '#/components/schemas/FormattedValue'
            endingStocks:
              $ref: '#/components/schemas/FormattedValue'
            areaPlanted:
              $ref: '#/components/schemas/FormattedValue'
            domesticConsumption:
              $ref: '#/components/schemas/FormattedValue'
            imports:
              $ref: '#/components/schemas/FormattedValue'
            crush:
              $ref: '#/components/schemas/FormattedValue'
            totalSupply:
              $ref: '#/components/schemas/FormattedValue'
            totalUse:
              $ref: '#/components/schemas/FormattedValue'
        raw:
          type: object
          description: Dados brutos da API
        timestamp:
          type: string
          format: date-time

    FormattedValue:
      type: object
      properties:
        value:
          type: number
          example: 125000
        formatted:
          type: string
          example: "125.000 mil toneladas"

    WeatherForecastResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        city:
          $ref: '#/components/schemas/City'
        forecasts:
          type: array
          items:
            $ref: '#/components/schemas/Forecast'
        hasImage:
          type: boolean
          example: true
        imagePath:
          type: string
          nullable: true
          example: "/path/to/image.png"
        timestamp:
          type: string
          format: date-time

    CurrentWeatherResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        city:
          $ref: '#/components/schemas/City'
        weather:
          $ref: '#/components/schemas/CurrentWeather'
        timestamp:
          type: string
          format: date-time

    City:
      type: object
      properties:
        name:
          type: string
          example: S√£o Paulo
        country:
          type: string
          example: BR
        state:
          type: string
          nullable: true
          example: S√£o Paulo
        coordinates:
          type: object
          properties:
            lat:
              type: number
              example: -23.5505
            lon:
              type: number
              example: -46.6333

    Forecast:
      type: object
      properties:
        date:
          type: string
          format: date-time
        dateFormatted:
          type: string
          example: "Ter√ßa-feira, 19 de novembro"
        icon:
          type: string
          example: "‚òÅÔ∏è"
        description:
          type: string
          example: "nuvens dispersas"
        temperature:
          type: object
          properties:
            current:
              type: integer
              example: 23
            min:
              type: integer
              example: 23
            max:
              type: integer
              example: 24
        humidity:
          type: integer
          example: 62
        windSpeed:
          type: integer
          example: 24
        rain:
          type: number
          example: 0

    CurrentWeather:
      type: object
      properties:
        icon:
          type: string
          example: "‚òÅÔ∏è"
        description:
          type: string
          example: "nuvens dispersas"
        temperature:
          type: object
          properties:
            current:
              type: integer
              example: 23
            feelsLike:
              type: integer
              example: 24
            min:
              type: integer
              example: 20
            max:
              type: integer
              example: 25
        humidity:
          type: integer
          example: 62
        pressure:
          type: integer
          example: 1013
        windSpeed:
          type: integer
          example: 15
        windDirection:
          type: integer
          nullable: true
          example: 180
        visibility:
          type: number
          nullable: true
          example: 10
        clouds:
          type: integer
          example: 75

    ClimaGenerateResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        city:
          type: string
          example: S√£o Paulo
        layer:
          type: string
          example: temp
        hours:
          type: integer
          example: 24
        imagePath:
          type: string
          example: "/path/to/saopaulo_windy_temp_24h.png"
        imageUrl:
          type: string
          example: "/api/clima/image/temp/saopaulo_windy_temp_24h.png"
        timestamp:
          type: string
          format: date-time

    ClimaImagesResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        city:
          type: string
          example: S√£o Paulo
        images:
          type: array
          items:
            type: object
            properties:
              layer:
                type: string
                example: temp
              fileName:
                type: string
                example: saopaulo_windy_temp_24h.png
              path:
                type: string
                example: "/path/to/image.png"
              url:
                type: string
                example: "/api/clima/image/temp/saopaulo_windy_temp_24h.png"
        count:
          type: integer
          example: 1
        timestamp:
          type: string
          format: date-time

    GeolocalizacaoResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "üìç *Informa√ß√µes da Propriedade*\n\nüìÅ *Arquivo:* propriedade.kml..."
        data:
          type: object
          properties:
            type:
              type: string
              example: kml
            totalArea:
              type: object
              properties:
                squareMeters:
                  type: number
                  example: 1234567
                hectares:
                  type: number
                  example: 123.4567
                squareKilometers:
                  type: number
                  example: 1.234567
            polygonCount:
              type: integer
              example: 1
            polygons:
              type: array
              items:
                type: object
                properties:
                  area:
                    type: object
                    properties:
                      squareMeters:
                        type: number
                      hectares:
                        type: number
                      squareKilometers:
                        type: number
                  centroid:
                    type: object
                    properties:
                      longitude:
                        type: number
                      latitude:
                        type: number
                  bbox:
                    type: object
                    properties:
                      minLon:
                        type: number
                      minLat:
                        type: number
                      maxLon:
                        type: number
                      maxLat:
                        type: number

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          example: "Mensagem de erro descritiva"
        timestamp:
          type: string
          format: date-time

